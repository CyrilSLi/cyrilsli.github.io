<!DOCTYPE html>
<html lang = "zh-CN">
<head>
    <title>迫害码生成器</title>
    <meta charset = "utf-8">
    <script src = "https://cdn.jsdelivr.net/npm/brython@3.11.0/brython.min.js"></script>
    <script src = "https://cdn.jsdelivr.net/npm/brython@3.11.0/brython_stdlib.js"></script>
    <script src = "https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    <style>
        :root {
            --landscape-scale: 1.85;
        }
        html, body {
            margin: 0px;
            display: flex;
            flex-direction: column;
        }
        p {
            font-family: Arial, sans-serif;
            font-size: min(9dvw, calc(9dvh / var(--landscape-scale)));
            margin: min(5dvw, calc(5dvh / var(--landscape-scale)));
            display: inline;
        }
        h1 {
            font-family: Arial, sans-serif;
            font-size: min(14dvw, calc(14dvh / var(--landscape-scale)));
            font-weight: bold;
            margin: min(5dvw, calc(5dvh / var(--landscape-scale))) min(5dvw, calc(5dvh / var(--landscape-scale))) min(1dvw, calc(1dvh / var(--landscape-scale)));
        }
        input {
            font-family: Arial, sans-serif;
            font-size: min(9dvw, calc(9dvh / var(--landscape-scale)));
            padding: min(1dvw, calc(1dvh / var(--landscape-scale)));
            margin: min(5dvw, calc(5dvh / var(--landscape-scale)));
            border-radius: 0px;
            text-decoration: none;
            font-weight: normal;
            background-color: #f8f8f8;
            color: black;
            -webkit-appearance: none;
            border: min(0.2dvw, calc(0.2dvw / var(--landscape-scale))) solid black;
        }
        .inline {
            margin: min(2.5dvw, calc(2.5dvh / var(--landscape-scale)));
            width: min(15dvw, calc(15dvh / var(--landscape-scale)));
        }
        #col {
            width: min(7dvw, calc(7dvh / var(--landscape-scale)));
        }
        #emuid {
            flex: 1;
            max-width: calc(87.6dvh / var(--landscape-scale));
        }
        img {
            border: 0px;
            margin: min(5dvw, calc(5dvh / var(--landscape-scale)));
            width: min(90dvw, calc(90dvh / var(--landscape-scale)));
        }
        div {
            margin: 0px;
        }
    </style>
</head>
<body onload = "brython (0)">
    <noscript>
        <p style = "display: block; font-size: 5dvw;">使用该网站需要JavaScript。</p>
    </noscript>
    <script type = "text/python">
        from browser import document, html, ajax, window
        from datetime import *
        global lastcol
        lastcol = "A"
        def oninput (ev):
            global lastcol
            if ev.target.id == "emuid" and len (ev.target.value) > 1:
                if ev.target.value [1] in "0123456789":
                    cndate = (datetime.now (timezone.utc) + timedelta (hours = 8)).strftime ("%Y%m%d")
                    ajax.get (f"https://corsproxy.io/?https://mobile.12306.cn/wxxcx/openplatform-inner/miniprogram/wifiapps/appFrontEnd/v2/lounge/open-smooth-common/trainStyleBatch/getCarDetail?carCode=&trainCode={ev.target.value [0].upper () + ev.target.value [1 : ]}&runningDay={cndate}&reqType=form&", mode = "json", oncomplete = getchedi)
                    document ["qr"].style.visibility = "hidden"
                    ev.target.value = "列车编号获取中..."
                elif ev.type == "focus" and ev.target.value == "列车编号获取失败":
                    ev.target.value = ""
                else:
                    model = ev.target.value.replace ("-", "").upper ()
                    for i, j in (("CR400", 7), ("CR300", 7), ("CR200J", 7), ("CRH380", 0), ("CRH", 5), ("", 0)):
                        if model.startswith (i) and len (model) > j:
                            ev.target.value = "-".join ((i for i in (model [ : min (j, len (model) - 4)], model [min (j, len (model) - 4) : -4], model [-4 : ]) if i))
                            break
                    genqr ()
            elif ev.target.id == "col":
                if len (ev.target.value) and ev.target.value [-1] in "AaBbCcDdFf":
                    ev.target.value = ev.target.value [-1].upper ()
                    lastcol = ev.target.value
                else:
                    ev.target.value = lastcol
                genqr ()
            elif ev.target.id in ("car", "row"):
                ev.target.value = ("00" + str (max (int ("00" + ev.target.value [-2 : ]), int (ev.type == "blur")))) [-2 : ]
                if ev.type == "blur":
                    ev.target.value = min (ev.target.value, "17" if ev.target.id == "car" else "20")
                genqr ()
        def getchedi (req):
            try:
                document ["emuid"].value = req.json ["content"] ["data"] ["carCode"]
                genqr ()
            except:
                document ["emuid"].value = "列车编号获取失败"
        def genqr ():
            document ["qr"].src = window.QRious.new ({"element": html.CANVAS (), "level": "M", "size": 814, "padding": 37, "value": f"https://p.12306.cn/tservice/qr/travel/v1?c={document ['emuid'].value}-{document ['car'].value}-{document ['row'].value}{document ['col'].value}&w=h"}).toDataURL ()
            document ["qr"].style.visibility = "visible"
        def emublur (ev):
            if ev.key == "Enter":
                ev.target.blur ()
        document.clear ()
        document <= html.H1 ("迫害码生成器", style = "flex: 1;")
        document <= html.INPUT (id = "emuid", placeholder = "列车编号或车次", autofocus = "autofocus")
        document <= html.DIV (id = "params")
        document ["params"] <= html.P ("车厢号:")
        document ["params"] <= html.INPUT (Class = "inline", type = "number", id = "car", value = "01", min = 1, max = 17)
        document ["params"] <= html.BR ()
        document ["params"] <= html.P ("座位号:")
        document ["params"] <= html.INPUT (Class = "inline", type = "number", id = "row", value = "01", min = 1, max = 20)
        document ["params"] <= html.INPUT (Class = "inline", id = "col", value = "A")
        document <= html.IMG (id = "qr")
        document ["emuid"].bind ("blur", oninput)
        document ["emuid"].bind ("focus", oninput)
        document ["emuid"].bind ("keydown", emublur)
        document ["car"].bind ("input", oninput)
        document ["row"].bind ("input", oninput)
        document ["car"].bind ("blur", oninput)
        document ["row"].bind ("blur", oninput)
        document ["col"].bind ("input", oninput)
    </script>
    <script>
        document.body.insertAdjacentHTML ("beforeend", '<p style = "display: block;">加载中...</p></div>')
    </script>
</body>
</html>
